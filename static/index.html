<!doctype html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéå Manga Translator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0f0f1a;
      --bg-secondary: #1a1a2e;
      --bg-card: #16213e;
      --accent: #e94560;
      --accent-light: #ff6b6b;
      --accent-gradient: linear-gradient(135deg, #e94560 0%, #ff6b6b 50%, #feca57 100%);
      --text-primary: #ffffff;
      --text-secondary: #a0a0b0;
      --success: #00d9a0;
      --border: rgba(255, 255, 255, 0.08);
      --shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Prompt', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      background-image:
        radial-gradient(ellipse at 20% 20%, rgba(233, 69, 96, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(100, 100, 255, 0.1) 0%, transparent 50%);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Header */
    header {
      text-align: center;
      padding: 40px 0 32px;
    }

    .logo {
      font-size: 2.5rem;
      font-weight: 700;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .tagline {
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: 300;
    }

    /* Main Grid */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-top: 24px;
    }

    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border);
      padding: 28px;
      box-shadow: var(--shadow);
    }

    .card-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title .icon {
      font-size: 1.5rem;
    }

    /* Form */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    /* Language Toggle */
    .lang-toggle {
      display: flex;
      gap: 12px;
    }

    .lang-btn {
      flex: 1;
      padding: 12px 20px;
      border-radius: 12px;
      border: 2px solid var(--border);
      background: transparent;
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .lang-btn:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .lang-btn.active {
      background: var(--accent-gradient);
      border-color: transparent;
      color: white;
    }

    .lang-btn input {
      display: none;
    }

    /* File Input */
    .file-drop {
      border: 2px dashed var(--border);
      border-radius: 16px;
      padding: 40px 20px;
      text-align: center;
      background: rgba(255, 255, 255, 0.02);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .file-drop:hover {
      border-color: var(--accent);
      background: rgba(233, 69, 96, 0.05);
    }

    .file-drop.dragover {
      border-color: var(--success);
      background: rgba(0, 217, 160, 0.1);
    }

    .file-drop .icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    .file-drop .text {
      color: var(--text-secondary);
    }

    .file-drop .filename {
      color: var(--success);
      font-weight: 500;
      margin-top: 8px;
      word-break: break-all;
    }

    .file-drop input {
      display: none;
    }

    /* Filename Input */
    .filename-input {
      width: 100%;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    .filename-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.2);
    }

    /* Submit Button */
    .submit-btn {
      width: 100%;
      padding: 16px;
      border-radius: 14px;
      border: none;
      background: var(--accent-gradient);
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(233, 69, 96, 0.4);
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Progress */
    .progress-container {
      margin-top: 20px;
      display: none;
    }

    .progress-container.show {
      display: block;
    }

    .progress-bar-bg {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: var(--accent-gradient);
      border-radius: 4px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .progress-text {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    /* Status */
    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
      font-size: 0.9rem;
      margin-top: 16px;
    }

    .status.success {
      background: rgba(0, 217, 160, 0.15);
      color: var(--success);
    }

    .status.error {
      background: rgba(233, 69, 96, 0.15);
      color: var(--accent-light);
    }

    /* Preview */
    .preview-area {
      min-height: 300px;
      border-radius: 16px;
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }

    .preview-area img {
      max-width: 100%;
      max-height: 500px;
      object-fit: contain;
      border-radius: 8px;
    }

    .preview-placeholder {
      color: var(--text-secondary);
      text-align: center;
    }

    .preview-placeholder .icon {
      font-size: 4rem;
      opacity: 0.5;
    }

    /* Download Button */
    .download-btn {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, #00d9a0 0%, #00b894 100%);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
      margin-top: 16px;
      display: none;
    }

    .download-btn.show {
      display: block;
    }

    .download-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0, 217, 160, 0.4);
    }

    /* Regions List */
    .regions-title {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 16px 0 8px;
    }

    .regions-list {
      max-height: 200px;
      overflow-y: auto;
      list-style: none;
    }

    .regions-list li {
      padding: 10px 12px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.03);
      margin-bottom: 8px;
      font-size: 0.85rem;
    }

    .regions-list .original {
      color: var(--text-secondary);
      font-size: 0.75rem;
      margin-top: 4px;
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 32px;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
    }

    .badge-row {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 8px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.05);
      font-size: 0.8rem;
    }

    .badge.gpu {
      background: rgba(0, 217, 160, 0.15);
      color: var(--success);
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="logo">üéå Manga Translator</div>
      <p class="tagline">‡πÅ‡∏õ‡∏•‡∏°‡∏±‡∏á‡∏á‡∏∞‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏î‡πâ‡∏ß‡∏¢ AI | ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö PDF ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
    </header>

    <div class="main-grid">
      <!-- Upload Card -->
      <div class="card">
        <h2 class="card-title"><span class="icon">üì§</span> ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå</h2>

        <form id="upload-form">
          <div class="form-group">
            <label>‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á</label>
            <div class="lang-toggle">
              <button type="button" class="lang-btn active" data-lang="en">
                üá¨üáß English
              </button>
              <button type="button" class="lang-btn" data-lang="ja">
                üáØüáµ Êó•Êú¨Ë™û
              </button>
            </div>
            <input type="hidden" name="source_lang" id="source-lang" value="en">
          </div>

          <div class="form-group">
            <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏´‡∏£‡∏∑‡∏≠ PDF)</label>
            <div class="file-drop" id="file-drop">
              <div class="icon">üìÅ</div>
              <div class="text">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á</div>
              <div class="filename" id="file-name"></div>
              <input type="file" id="file-input" accept="image/png,image/jpeg,image/jpg,application/pdf" required>
            </div>
          </div>

          <div class="form-group">
            <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
            <input type="text" class="filename-input" id="output-filename" placeholder="translated_manga">
          </div>

          <button type="submit" class="submit-btn" id="submit-btn">
            üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏õ‡∏•
          </button>

          <div class="progress-container" id="progress-container">
            <div class="progress-bar-bg">
              <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="progress-text">
              <span id="progress-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...</span>
              <span id="progress-pages">0/0 ‡∏´‡∏ô‡πâ‡∏≤</span>
            </div>
          </div>

          <div class="status" id="status-box" style="display:none;">
            <span id="status-text"></span>
          </div>
        </form>
      </div>

      <!-- Result Card -->
      <div class="card">
        <h2 class="card-title"><span class="icon">‚ú®</span> ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h2>

        <div class="preview-area" id="preview-area">
          <div class="preview-placeholder">
            <div class="icon">üñºÔ∏è</div>
            <p>‡∏£‡∏≠‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå...</p>
          </div>
          <img id="result-image" alt="Translated" style="display:none;">
        </div>

        <button class="download-btn" id="download-btn">
          üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
        </button>

        <p class="regions-title">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö:</p>
        <ul class="regions-list" id="regions-list"></ul>
      </div>
    </div>

    <footer>
      <p>Manga Translator v2.0 | Powered by NLLB-200 + Manga-OCR</p>
      <div class="badge-row">
        <span class="badge" id="device-badge">üíª Loading...</span>
        <span class="badge">üîß Local Processing</span>
      </div>
    </footer>
  </div>

  <script>
    // Elements
    const form = document.getElementById('upload-form');
    const fileInput = document.getElementById('file-input');
    const fileDrop = document.getElementById('file-drop');
    const fileName = document.getElementById('file-name');
    const outputFilename = document.getElementById('output-filename');
    const submitBtn = document.getElementById('submit-btn');
    const statusBox = document.getElementById('status-box');
    const statusText = document.getElementById('status-text');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const progressStatus = document.getElementById('progress-status');
    const progressPages = document.getElementById('progress-pages');
    const resultImage = document.getElementById('result-image');
    const previewArea = document.getElementById('preview-area');
    const downloadBtn = document.getElementById('download-btn');
    const regionsList = document.getElementById('regions-list');
    const langBtns = document.querySelectorAll('.lang-btn');
    const sourceLangInput = document.getElementById('source-lang');
    const deviceBadge = document.getElementById('device-badge');

    let currentResult = null;
    let isPdf = false;

    // Check device
    fetch('/health').then(r => r.json()).then(data => {
      deviceBadge.textContent = data.device === 'cuda' ? 'üöÄ GPU Enabled' : 'üíª CPU Mode';
      if (data.device === 'cuda') deviceBadge.classList.add('gpu');
    });

    // Language toggle
    langBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        langBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        sourceLangInput.value = btn.dataset.lang;
      });
    });

    // File drop
    fileDrop.addEventListener('click', () => fileInput.click());
    fileDrop.addEventListener('dragover', (e) => {
      e.preventDefault();
      fileDrop.classList.add('dragover');
    });
    fileDrop.addEventListener('dragleave', () => fileDrop.classList.remove('dragover'));
    fileDrop.addEventListener('drop', (e) => {
      e.preventDefault();
      fileDrop.classList.remove('dragover');
      if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        updateFileName();
      }
    });

    fileInput.addEventListener('change', updateFileName);

    function updateFileName() {
      if (fileInput.files.length) {
        const file = fileInput.files[0];
        fileName.textContent = file.name;
        // Set default output filename
        const baseName = file.name.replace(/\.[^/.]+$/, '');
        outputFilename.value = `${baseName}_translated`;
      }
    }

    function setStatus(text, type = '') {
      statusBox.style.display = 'flex';
      statusBox.className = 'status ' + type;
      statusText.textContent = text;
    }

    function hideStatus() {
      statusBox.style.display = 'none';
    }

    function showProgress(show) {
      progressContainer.classList.toggle('show', show);
    }

    function updateProgress(current, total, status = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•...') {
      const percent = total > 0 ? (current / total) * 100 : 0;
      progressBar.style.width = `${percent}%`;
      progressStatus.textContent = status;
      progressPages.textContent = `${current}/${total} ‡∏´‡∏ô‡πâ‡∏≤`;
    }

    function renderRegions(regions) {
      regionsList.innerHTML = '';
      if (!regions || !regions.length) {
        regionsList.innerHTML = '<li>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</li>';
        return;
      }
      regions.forEach((r, i) => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>#${i + 1}</strong> ${r.translation || '-'}
          <div class="original">‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö: ${r.text}</div>`;
        regionsList.appendChild(li);
      });
    }

    function downloadFile() {
      if (!currentResult) return;
      const filename = outputFilename.value || 'translated';

      if (isPdf) {
        const link = document.createElement('a');
        link.href = `data:application/pdf;base64,${currentResult.pdf_base64}`;
        link.download = `${filename}.pdf`;
        link.click();
      } else {
        const link = document.createElement('a');
        link.href = `data:image/png;base64,${currentResult.image_base64}`;
        link.download = `${filename}.png`;
        link.click();
      }
    }

    downloadBtn.addEventListener('click', downloadFile);

    // Form submit
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!fileInput.files.length) {
        setStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå', 'error');
        return;
      }

      const file = fileInput.files[0];
      isPdf = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
      const sourceLang = sourceLangInput.value;

      // Reset UI
      submitBtn.disabled = true;
      hideStatus();
      downloadBtn.classList.remove('show');
      resultImage.style.display = 'none';
      previewArea.querySelector('.preview-placeholder').style.display = 'flex';
      currentResult = null;

      const formData = new FormData();
      formData.append('file', file);

      try {
        if (isPdf) {
          // Generate task ID
          const taskId = 'task_' + Date.now();
          showProgress(true);
          updateProgress(0, 0, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...');

          // Start polling for progress
          const pollInterval = setInterval(async () => {
            try {
              const prog = await fetch(`/api/progress/${taskId}`).then(r => r.json());
              if (prog.total > 0) {
                updateProgress(prog.current, prog.total, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏´‡∏ô‡πâ‡∏≤...');
              }
              if (prog.status === 'done' || prog.status === 'error') {
                clearInterval(pollInterval);
              }
            } catch (err) { }
          }, 500);

          const res = await fetch(`/api/process-pdf?source_lang=${sourceLang}&task_id=${taskId}`, {
            method: 'POST',
            body: formData
          });

          clearInterval(pollInterval);
          showProgress(false);

          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.detail || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
          }

          currentResult = await res.json();
          downloadBtn.classList.add('show');
          setStatus(`‚úÖ ‡πÅ‡∏õ‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${currentResult.total_pages} ‡∏´‡∏ô‡πâ‡∏≤`, 'success');
          renderRegions(currentResult.regions);
          previewArea.querySelector('.preview-placeholder').innerHTML = '<div class="icon">üìÑ</div><p>PDF ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</p>';

        } else {
          setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•...', '');

          const res = await fetch(`/api/process?source_lang=${sourceLang}`, {
            method: 'POST',
            body: formData
          });

          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.detail || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
          }

          currentResult = await res.json();
          resultImage.src = `data:image/png;base64,${currentResult.image_base64}`;
          resultImage.style.display = 'block';
          previewArea.querySelector('.preview-placeholder').style.display = 'none';
          downloadBtn.classList.add('show');
          setStatus(`‚úÖ ‡πÅ‡∏õ‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${currentResult.meta?.translations || 0} ‡∏Å‡∏•‡πà‡∏≠‡∏á`, 'success');
          renderRegions(currentResult.regions);
        }

      } catch (err) {
        console.error(err);
        setStatus(`‚ùå ${err.message}`, 'error');
        showProgress(false);
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>

</html>